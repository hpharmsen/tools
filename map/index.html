<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, viewport-fit=cover">
    <title>City Explorer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { height: 100%; overflow: hidden; }
        body { font-family: -apple-system, 'Segoe UI', Arial, sans-serif; height: 100vh; height: 100dvh; display: flex; flex-direction: column; background: #f5f5f5; overflow: hidden; }

        .header { background: #2c3e50; color: white; padding: 14px 20px; padding-top: calc(14px + env(safe-area-inset-top, 0px)); padding-left: calc(20px + env(safe-area-inset-left, 0px)); padding-right: calc(20px + env(safe-area-inset-right, 0px)); display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
        .header h1 { font-size: 1.3em; font-weight: 700; }
        .header-btns { display: flex; gap: 8px; }
        .header-btn { background: rgba(255,255,255,0.15); color: white; border: none; padding: 6px 14px; border-radius: 4px; cursor: pointer; font-size: 13px; }
        .header-btn:hover { background: rgba(255,255,255,0.25); }

        .mobile-tabs { display: none; flex-shrink: 0; background: #34495e; }
        .mobile-tabs .tab { flex: 1; padding: 10px; border: none; background: transparent; color: rgba(255,255,255,0.5); font-size: 14px; font-weight: 600; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.2s; }
        .mobile-tabs .tab.active { color: white; border-bottom-color: #4a90d9; }
        .tab-badge { width: 8px; height: 8px; background: #e74c3c; border-radius: 50%; margin-left: 6px; vertical-align: middle; display: none; }

        .content { display: flex; flex: 1; min-height: 0; }

        .chat-panel { width: 55%; display: flex; flex-direction: column; min-height: 0; }
        .map-panel { width: 45%; position: relative; }

        .messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
        .message { max-width: 88%; padding: 12px 16px; border-radius: 12px; line-height: 1.6; font-size: 14px; }
        .message.user { background: #4a90d9; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .message.assistant { background: white; color: #333; align-self: flex-start; border-bottom-left-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .message.assistant h1, .message.assistant h2, .message.assistant h3 { margin: 10px 0 4px; color: #2c3e50; }
        .message.assistant h1 { font-size: 1.2em; }
        .message.assistant h2 { font-size: 1.1em; }
        .message.assistant h3 { font-size: 1em; }
        .message.assistant ul, .message.assistant ol { margin: 4px 0 4px 20px; }
        .message.assistant li { margin: 2px 0; }
        .message.assistant p { margin: 6px 0; }
        .message.assistant strong { color: #2c3e50; }
        .message.assistant a { color: #4a90d9; }
        .message.assistant hr { border: none; border-top: 1px solid #eee; margin: 10px 0; }
        .message.welcome { background: #eef6ff; color: #2c3e50; align-self: center; text-align: center; max-width: 90%; padding: 24px; }
        .message.welcome h2 { margin-bottom: 8px; color: #2c3e50; }
        .message.welcome p { color: #555; }

        .typing { display: flex; gap: 4px; padding: 14px 18px; background: white; border-radius: 12px; align-self: flex-start; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .typing span { width: 8px; height: 8px; background: #bbb; border-radius: 50%; animation: bounce 1.2s infinite; }
        .typing span:nth-child(2) { animation-delay: 0.2s; }
        .typing span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        .input-area { padding: 12px 16px; padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px)); background: white; border-top: 1px solid #e0e0e0; display: flex; gap: 8px; flex-shrink: 0; }
        .input-area input { flex: 1; padding: 10px 16px; border: 2px solid #e0e0e0; border-radius: 20px; font-size: 16px; outline: none; -webkit-appearance: none; }
        .input-area input:focus { border-color: #4a90d9; }
        .input-area button { background: #4a90d9; color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-size: 14px; font-weight: 600; white-space: nowrap; }
        .input-area button:hover { background: #357abd; }
        .input-area button:disabled { background: #ccc; cursor: not-allowed; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 2000; }
        .modal { background: white; padding: 30px; border-radius: 12px; max-width: 440px; width: 90%; }
        .modal h2 { margin-bottom: 10px; color: #2c3e50; }
        .modal p { margin-bottom: 16px; color: #666; font-size: 14px; line-height: 1.5; }
        .modal p a { color: #4a90d9; }
        .modal input { width: 100%; padding: 10px 14px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 16px; margin-bottom: 12px; outline: none; -webkit-appearance: none; }
        .modal input:focus { border-color: #4a90d9; }
        .modal button { background: #4a90d9; color: white; border: none; padding: 10px 24px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; width: 100%; }
        .modal button:hover { background: #357abd; }
        .modal .error { color: #c00; font-size: 13px; margin-bottom: 8px; display: none; }

        #map { width: 100%; height: 100%; }

        .map-loading { position: absolute; bottom: calc(20px + env(safe-area-inset-bottom, 0px)); left: 50%; transform: translateX(-50%); background: white; padding: 10px 20px; border-radius: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 1000; display: none; font-size: 13px; color: #555; }
        .map-loading .spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid #ddd; border-top-color: #4a90d9; border-radius: 50%; animation: spin 0.8s linear infinite; vertical-align: middle; margin-right: 8px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .legend { background: white; padding: 10px 14px; border-radius: 6px; box-shadow: 0 1px 5px rgba(0,0,0,0.3); line-height: 1.8; font-size: 12px; max-height: 45vh; overflow-y: auto; column-count: 2; column-gap: 16px; }
        .legend-item { display: flex; align-items: center; gap: 6px; break-inside: avoid; }
        .legend-dot { width: 18px; height: 18px; min-width: 18px; border-radius: 50%; display: inline-block; border: 1px solid rgba(0,0,0,0.2); }

        @media (max-width: 768px) {
            .mobile-tabs { display: flex; }
            .content { flex-direction: column; }
            .chat-panel { width: 100%; flex: 1; }
            .map-panel { width: 100%; flex: 1; display: none; }
            body.show-map .chat-panel { display: none; }
            body.show-map .map-panel { display: block; }
            .header h1 { font-size: 1.1em; }
            .header { padding: 10px 12px; padding-top: calc(10px + env(safe-area-inset-top, 0px)); }
            .header-btn { padding: 5px 10px; font-size: 12px; }
            .messages { padding: 10px; gap: 8px; }
            .message { max-width: 95%; padding: 10px 12px; font-size: 14px; }
            .message.welcome { padding: 16px; }
            .input-area { padding: 8px 10px; padding-bottom: calc(8px + env(safe-area-inset-bottom, 0px)); gap: 6px; }
            .input-area button { padding: 10px 14px; font-size: 14px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>City Explorer</h1>
        <div class="header-btns">
            <button class="header-btn" id="new-btn">Nieuwe stad</button>
            <button class="header-btn" id="key-btn">API Key</button>
        </div>
    </div>
    <div class="mobile-tabs" id="mobile-tabs">
        <button class="tab active" data-tab="chat">Chat</button>
        <button class="tab" data-tab="map">Kaart <span class="tab-badge" id="map-badge"></span></button>
    </div>
    <div class="content">
        <div class="chat-panel" id="chat-panel">
            <div class="messages" id="messages">
                <div class="message welcome">
                    <h2>Welkom bij City Explorer!</h2>
                    <p>Typ de naam van een stad en ontdek de mooiste bezienswaardigheden en lekkerste restaurants.</p>
                </div>
            </div>
            <div class="input-area">
                <input type="text" id="user-input" placeholder="Bijv. 'Lissabon' of 'Welke restaurants bij het centrum?'" />
                <button id="send-btn">Verstuur</button>
            </div>
        </div>
        <div class="map-panel" id="map-panel">
            <div id="map"></div>
            <div class="map-loading" id="map-loading">
                <span class="spinner"></span>
                <span id="map-loading-text">Locaties opzoeken...</span>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="api-modal" style="display:none;">
        <div class="modal">
            <h2>Gemini API Key</h2>
            <p>Voer je Google Gemini API key in. Je kunt er gratis een aanmaken op <a href="https://aistudio.google.com/apikey" target="_blank">aistudio.google.com</a>.</p>
            <div class="error" id="key-error"></div>
            <input type="password" id="api-key-input" placeholder="AIza..." />
            <button id="save-key-btn">Opslaan</button>
        </div>
    </div>

    <script>
        var MODEL = 'gemini-2.5-flash';
        var API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/' + MODEL + ':generateContent';
        var NOMINATIM_URL = 'https://nominatim.openstreetmap.org/search';

        var SYSTEM_PROMPT = 'Je bent City Explorer, een Nederlandstalige stadsgids gericht op stellen tussen 30 en 70 jaar.\n\n' +
            'BELANGRIJK: Gebruik ALTIJD de Google Search tool om actuele informatie op te zoeken over de stad. Zoek naar "best things to do in [city]", "[city] must visit places", "[city] best restaurants" en dergelijke. Vertrouw NIET alleen op je eigen kennis.\n\n' +
            'ANTWOORDFORMAAT:\n' +
            'Als iemand een stad noemt, geef je antwoord in deze vaste structuur:\n\n' +
            '1. **Korte inleiding** (2-3 zinnen): wat maakt deze stad de moeite waard? Geen reclametaal, gewoon eerlijk en informatief.\n\n' +
            '2. **Bezienswaardigheden** (genummerd 1 t/m 10): een mix van bekende highlights en minder bekende parels. Denk aan architectuur, markten, parken, musea, wijken, straatkunst. Per item: de naam, en in 1-2 zinnen wat het is en waarom het interessant is.\n\n' +
            '3. **Horeca** (geletterd A t/m E of meer): restaurants, cafés en andere eetplekken. Gebruik markdown-opsommingstekens (elk item op een eigen regel, voorafgegaan door een streepje). Per item: de letter vetgedrukt, de naam, wat voor keuken/sfeer, en eventueel een tip. Voorbeeld:\n' +
            '- **A.** Naam — beschrijving\n' +
            '- **B.** Naam — beschrijving\n\n' +
            'STIJLREGELS:\n' +
            '- Schrijf in het Nederlands\n' +
            '- Vriendelijk en to the point — geen marketingtaal, geen overdrijvingen zoals "laat je zintuigen prikkelen", "een waar paradijs", "je waant je in", etc.\n' +
            '- Gewoon helder vertellen wat er te zien en te doen is\n' +
            '- Geef concrete, praktische informatie\n' +
            '- Vraag om verduidelijking bij onduidelijke verzoeken\n\n' +
            'BELANGRIJK TECHNISCH VEREISTE:\n' +
            'Voeg aan het EINDE van elk antwoord een JSON-blok toe met ALLE genoemde locaties. Gebruik PRECIES dit formaat:\n\n' +
            '[LOCATIONS]\n' +
            '{"city": "City, Country", "places": [{"name": "Naam", "category": "Categorie", "lat": 0.0, "lon": 0.0}]}\n' +
            '[/LOCATIONS]\n\n' +
            'Regels voor het LOCATIONS blok:\n' +
            '- "city": de Engelse naam van de stad + land (bijv. "Lisbon, Portugal", "Prague, Czech Republic")\n' +
            '- "name": gebruik de KORTE, meest gangbare naam van de plek. Gebruik de lokale taal.\n' +
            '- "lat" en "lon": de geschatte GPS-coördinaten (decimale graden). Dit is essentieel voor de kaart.\n' +
            '- Voeg ALLE genoemde plekken toe — zowel de bezienswaardigheden als de horeca\n' +
            '- Als er geen specifieke locaties worden genoemd, laat het LOCATIONS blok weg\n' +
            '- Categorieën voor bezienswaardigheden: Bezienswaardigheid, Museum, Park, Boulevard, Markt, Kerk, Overig\n' +
            '- Categorieën voor horeca: Restaurant, Café, Hotel\n\n' +
            'Voorbeeld LOCATIONS blok:\n' +
            '[LOCATIONS]\n' +
            '{"city": "Lisbon, Portugal", "places": [{"name": "Torre de Belém", "category": "Bezienswaardigheid", "lat": 38.6916, "lon": -9.2160}, {"name": "Time Out Market", "category": "Restaurant", "lat": 38.7069, "lon": -9.1455}]}\n' +
            '[/LOCATIONS]';

        var apiKey = localStorage.getItem('gemini_api_key') || '';
        var conversationHistory = [];
        var useGoogleSearch = true;
        var geocodeAbortController = null;
        var activeTab = 'chat';

        // Map setup
        var map = L.map('map').setView([48.8, 10], 4);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
            maxZoom: 19
        }).addTo(map);

        var markersLayer = L.layerGroup().addTo(map);
        var legendControl = null;

        var CATEGORY_COLORS = {
            'Bezienswaardigheid': '#e74c3c',
            'Restaurant': '#f39c12',
            'Museum': '#9b59b6',
            'Park': '#2ecc71',
            'Boulevard': '#3498db',
            'Markt': '#e67e22',
            'Kerk': '#34495e',
            'Hotel': '#1abc9c',
            'Café': '#d35400',
            'Overig': '#95a5a6'
        };

        // --- Tabs ---

        function switchTab(tab) {
            activeTab = tab;
            document.querySelectorAll('.mobile-tabs .tab').forEach(function(t) {
                t.classList.toggle('active', t.dataset.tab === tab);
            });
            if (tab === 'map') {
                document.body.classList.add('show-map');
                document.getElementById('map-badge').style.display = 'none';
                // Leaflet must recalculate size when container becomes visible
                setTimeout(function() { map.invalidateSize(); }, 50);
            } else {
                document.body.classList.remove('show-map');
            }
        }

        document.getElementById('mobile-tabs').addEventListener('click', function(e) {
            var tab = e.target.closest('.tab');
            if (tab) switchTab(tab.dataset.tab);
        });

        function notifyMapReady() {
            // Show badge on Kaart tab if user is on Chat tab (mobile only)
            if (activeTab === 'chat' && window.innerWidth <= 768) {
                document.getElementById('map-badge').style.display = 'inline-block';
            }
        }

        // --- API Key ---

        function checkApiKey() {
            if (!apiKey) {
                document.getElementById('api-modal').style.display = 'flex';
                document.getElementById('api-key-input').focus();
            }
        }

        function saveApiKey() {
            var key = document.getElementById('api-key-input').value.trim();
            if (!key || key.length < 10) {
                var err = document.getElementById('key-error');
                err.textContent = 'Voer een geldige API key in.';
                err.style.display = 'block';
                return;
            }
            apiKey = key;
            localStorage.setItem('gemini_api_key', key);
            document.getElementById('api-modal').style.display = 'none';
            document.getElementById('key-error').style.display = 'none';
            document.getElementById('user-input').focus();
        }

        // --- Chat UI ---

        function addMessage(content, role) {
            var messagesEl = document.getElementById('messages');
            var msgEl = document.createElement('div');
            msgEl.className = 'message ' + role;

            if (role === 'assistant') {
                msgEl.innerHTML = marked.parse(content);
            } else {
                msgEl.textContent = content;
            }

            messagesEl.appendChild(msgEl);
            messagesEl.scrollTop = messagesEl.scrollHeight;
            return msgEl;
        }

        function showTyping() {
            var messagesEl = document.getElementById('messages');
            var el = document.createElement('div');
            el.className = 'typing';
            el.id = 'typing-indicator';
            el.innerHTML = '<span></span><span></span><span></span>';
            messagesEl.appendChild(el);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        function hideTyping() {
            var el = document.getElementById('typing-indicator');
            if (el) el.remove();
        }

        // --- Response parsing ---

        function cleanResponseText(text) {
            text = text.replace(/<think>[\s\S]*?<\/think>/g, '');
            text = text.replace(/\[LOCATIONS\][\s\S]*?\[\/LOCATIONS\]/, '');
            return text.trim();
        }

        function extractLocations(text) {
            var locMatch = text.match(/\[LOCATIONS\]([\s\S]*?)\[\/LOCATIONS\]/);
            if (!locMatch) return null;

            try {
                var data = JSON.parse(locMatch[1].trim());
                if (data.city && Array.isArray(data.places)) {
                    return data;
                }
                if (Array.isArray(data)) {
                    return { city: '', places: data };
                }
            } catch (e) {
                console.warn('Locaties parseren mislukt:', e);
            }
            return null;
        }

        // --- Nominatim geocoding ---

        function setMapLoading(show, text) {
            var el = document.getElementById('map-loading');
            el.style.display = show ? 'flex' : 'none';
            if (text) document.getElementById('map-loading-text').textContent = text;
        }

        function sleep(ms) {
            return new Promise(function(resolve) { setTimeout(resolve, ms); });
        }

        // Calculate distance in km between two lat/lon points (Haversine)
        function distanceKm(lat1, lon1, lat2, lon2) {
            var R = 6371;
            var dLat = (lat2 - lat1) * Math.PI / 180;
            var dLon = (lon2 - lon1) * Math.PI / 180;
            var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        // Geocode the city itself to get a reference point
        var cityCenter = null;
        var MAX_DISTANCE_KM = 60;

        async function geocodeCity(city) {
            var url = NOMINATIM_URL + '?q=' + encodeURIComponent(city) + '&format=json&limit=1';
            var resp = await fetch(url);
            var results = await resp.json();
            if (results.length > 0) {
                return { lat: parseFloat(results[0].lat), lon: parseFloat(results[0].lon) };
            }
            return null;
        }

        async function geocodePlace(name, city) {
            var query = name + ', ' + city;
            var url = NOMINATIM_URL + '?q=' + encodeURIComponent(query) + '&format=json&limit=1&accept-language=nl';
            var resp = await fetch(url);
            var results = await resp.json();

            if (results.length > 0) {
                var lat = parseFloat(results[0].lat);
                var lon = parseFloat(results[0].lon);
                if (cityCenter && distanceKm(cityCenter.lat, cityCenter.lon, lat, lon) < MAX_DISTANCE_KM) {
                    return { lat: lat, lon: lon };
                }
                // If too far from city center, this is likely a wrong match — skip fallback
                if (cityCenter && distanceKm(cityCenter.lat, cityCenter.lon, lat, lon) >= MAX_DISTANCE_KM) {
                    console.warn('Geocode result for "' + name + '" too far from city (' +
                        Math.round(distanceKm(cityCenter.lat, cityCenter.lon, lat, lon)) + ' km), skipping');
                    return null;
                }
                return { lat: lat, lon: lon };
            }

            // Fallback: search without city, but still validate distance
            url = NOMINATIM_URL + '?q=' + encodeURIComponent(name) + '&format=json&limit=1';
            resp = await fetch(url);
            results = await resp.json();

            if (results.length > 0) {
                var lat = parseFloat(results[0].lat);
                var lon = parseFloat(results[0].lon);
                if (cityCenter && distanceKm(cityCenter.lat, cityCenter.lon, lat, lon) >= MAX_DISTANCE_KM) {
                    console.warn('Fallback geocode for "' + name + '" too far from city (' +
                        Math.round(distanceKm(cityCenter.lat, cityCenter.lon, lat, lon)) + ' km), skipping');
                    return null;
                }
                return { lat: lat, lon: lon };
            }

            return null;
        }

        async function geocodeAndShowLocations(locationData) {
            if (!locationData || !locationData.places || locationData.places.length === 0) return;

            if (geocodeAbortController) {
                geocodeAbortController.abort();
            }
            geocodeAbortController = new AbortController();
            var signal = geocodeAbortController.signal;

            var city = locationData.city;
            var places = locationData.places;
            var total = places.length;

            // Check which places already have coordinates from the LLM
            var placesWithCoords = places.filter(function(p) { return p.lat && p.lon; });
            var placesWithoutCoords = places.filter(function(p) { return !p.lat || !p.lon; });

            markersLayer.clearLayers();
            if (legendControl) {
                map.removeControl(legendControl);
                legendControl = null;
            }

            var geocoded = [];

            // Add places that already have coordinates
            placesWithCoords.forEach(function(place) {
                geocoded.push({
                    name: place.name,
                    category: place.category || 'Overig',
                    lat: place.lat,
                    lon: place.lon
                });
            });

            // Only geocode places without coordinates
            if (placesWithoutCoords.length > 0) {
                // Get city center for validation
                try {
                    cityCenter = await geocodeCity(city);
                    await sleep(1000);
                } catch (e) {
                    cityCenter = null;
                }

                setMapLoading(true, 'Locaties opzoeken... (0/' + placesWithoutCoords.length + ')');

                for (var i = 0; i < placesWithoutCoords.length; i++) {
                    if (signal.aborted) return;

                    var place = placesWithoutCoords[i];
                    setMapLoading(true, 'Locaties opzoeken... (' + (i + 1) + '/' + placesWithoutCoords.length + ')');

                    try {
                        var coords = await geocodePlace(place.name, city);
                        if (coords) {
                            geocoded.push({
                                name: place.name,
                                category: place.category || 'Overig',
                                lat: coords.lat,
                                lon: coords.lon
                            });
                        }
                    } catch (e) {
                        console.warn('Geocoding mislukt voor:', place.name, e);
                    }

                    if (i < placesWithoutCoords.length - 1) {
                        await sleep(1000);
                    }
                }
            }

            if (signal.aborted) return;

            setMapLoading(false);
            showOnMap(geocoded);
            notifyMapReady();
        }

        // --- Map display ---

        var HORECA_CATEGORIES = ['Restaurant', 'Café', 'Hotel'];

        function isHoreca(category) {
            return HORECA_CATEGORIES.indexOf(category) !== -1;
        }

        function createLabelIcon(color, label) {
            var fontSize = label.length > 1 ? '8' : '10';
            return L.divIcon({
                html: '<svg width="22" height="32" viewBox="0 0 22 32">' +
                    '<path d="M11 0C4.9 0 0 4.9 0 11c0 8.3 11 21 11 21s11-12.7 11-21C22 4.9 17.1 0 11 0z" fill="' + color + '" stroke="#fff" stroke-width="1.5"/>' +
                    '<text x="11" y="13" text-anchor="middle" fill="#fff" font-family="-apple-system,Segoe UI,Arial,sans-serif" font-size="' + fontSize + '" font-weight="700">' + label + '</text>' +
                    '</svg>',
                className: '',
                iconSize: [22, 32],
                iconAnchor: [11, 32],
                popupAnchor: [0, -28]
            });
        }

        function showOnMap(locations) {
            markersLayer.clearLayers();
            if (legendControl) {
                map.removeControl(legendControl);
                legendControl = null;
            }

            if (locations.length === 0) return;

            // Assign labels: 1,2,3... for highlights, A,B,C... for horeca
            var highlightNum = 1;
            var horecaNum = 0; // 0=A, 1=B, etc.

            locations.forEach(function(loc) {
                if (isHoreca(loc.category)) {
                    loc.label = String.fromCharCode(65 + horecaNum); // A, B, C...
                    horecaNum++;
                } else {
                    loc.label = String(highlightNum);
                    highlightNum++;
                }
            });

            var categories = [];
            locations.forEach(function(l) {
                if (categories.indexOf(l.category) === -1) categories.push(l.category);
            });

            var latlngs = [];

            locations.forEach(function(loc) {
                var color = CATEGORY_COLORS[loc.category] || CATEGORY_COLORS['Overig'];
                var icon = createLabelIcon(color, loc.label);
                var marker = L.marker([loc.lat, loc.lon], { icon: icon });
                marker.bindPopup('<strong>' + loc.label + '. ' + loc.name + '</strong><br><em>' + loc.category + '</em>');
                markersLayer.addLayer(marker);
                latlngs.push([loc.lat, loc.lon]);
            });

            var bounds = L.latLngBounds(latlngs);
            map.invalidateSize();
            setTimeout(function() {
                map.fitBounds(bounds, { padding: [50, 50], maxZoom: 14 });
            }, 100);

            legendControl = L.control({ position: 'bottomright' });
            legendControl.onAdd = function() {
                var div = L.DomUtil.create('div', 'legend');
                locations.forEach(function(loc) {
                    var item = document.createElement('div');
                    item.className = 'legend-item';
                    var c = CATEGORY_COLORS[loc.category] || CATEGORY_COLORS['Overig'];
                    item.innerHTML = '<span class="legend-dot" style="background:' + c + '">' +
                        '<span style="color:#fff;font-size:9px;font-weight:700;display:flex;align-items:center;justify-content:center;height:100%">' + loc.label + '</span>' +
                        '</span> ' + loc.name;
                    div.appendChild(item);
                });
                return div;
            };
            legendControl.addTo(map);
        }

        // --- Gemini API ---

        async function callGemini(history) {
            var body = {
                system_instruction: { parts: [{ text: SYSTEM_PROMPT }] },
                contents: history
            };

            if (useGoogleSearch) {
                body.tools = [{ google_search: {} }];
            }

            var response = await fetch(API_URL + '?key=' + apiKey, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });

            if (!response.ok) {
                var errData = await response.json();
                var errMsg = (errData.error && errData.error.message) || 'API fout';
                if (useGoogleSearch && (response.status === 400 || errMsg.toLowerCase().indexOf('tool') !== -1 || errMsg.toLowerCase().indexOf('search') !== -1)) {
                    useGoogleSearch = false;
                    return callGemini(history);
                }
                throw new Error(errMsg);
            }

            return response.json();
        }

        // --- Send message ---

        async function sendMessage() {
            var input = document.getElementById('user-input');
            var text = input.value.trim();
            if (!text) return;

            if (!apiKey) {
                checkApiKey();
                return;
            }

            input.value = '';
            addMessage(text, 'user');

            conversationHistory.push({ role: 'user', parts: [{ text: text }] });

            showTyping();
            document.getElementById('send-btn').disabled = true;

            try {
                var data = await callGemini(conversationHistory);

                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                    throw new Error('Geen antwoord ontvangen van Gemini.');
                }

                var parts = data.candidates[0].content.parts;
                var fullText = parts
                    .filter(function(p) { return p.text && !p.thought; })
                    .map(function(p) { return p.text; })
                    .join('');

                conversationHistory.push({ role: 'model', parts: [{ text: fullText }] });

                var locationData = extractLocations(fullText);
                var displayText = cleanResponseText(fullText);

                hideTyping();
                addMessage(displayText, 'assistant');

                if (locationData) {
                    geocodeAndShowLocations(locationData);
                }
            } catch (e) {
                hideTyping();
                addMessage('Er ging iets mis: ' + e.message, 'assistant');
                conversationHistory.pop();
            }

            document.getElementById('send-btn').disabled = false;
            input.focus();
        }

        // --- Event listeners ---

        document.getElementById('send-btn').addEventListener('click', sendMessage);

        document.getElementById('user-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') sendMessage();
        });

        document.getElementById('save-key-btn').addEventListener('click', saveApiKey);

        document.getElementById('api-key-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') saveApiKey();
        });

        document.getElementById('key-btn').addEventListener('click', function() {
            document.getElementById('api-key-input').value = apiKey;
            document.getElementById('api-modal').style.display = 'flex';
            document.getElementById('api-key-input').focus();
        });

        document.getElementById('new-btn').addEventListener('click', function() {
            if (geocodeAbortController) geocodeAbortController.abort();
            conversationHistory = [];
            document.getElementById('messages').innerHTML =
                '<div class="message welcome">' +
                '<h2>Welkom bij City Explorer!</h2>' +
                '<p>Typ de naam van een stad en ontdek de mooiste bezienswaardigheden en lekkerste restaurants.</p>' +
                '</div>';
            markersLayer.clearLayers();
            if (legendControl) {
                map.removeControl(legendControl);
                legendControl = null;
            }
            setMapLoading(false);
            map.setView([48.8, 10], 4);
            document.getElementById('map-badge').style.display = 'none';
            if (activeTab === 'map') switchTab('chat');
            document.getElementById('user-input').focus();
        });

        // Init
        checkApiKey();
    </script>
</body>
</html>
